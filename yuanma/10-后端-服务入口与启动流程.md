# 后端：服务入口与启动流程

## 主入口：backend/server.js
源码：[server.js](file:///f:/C/backend/server.js#L1-L175)

### 启动阶段做了什么
- 创建 Express + HTTP Server + Socket.IO Server：[server.js](file:///f:/C/backend/server.js#L42-L47)
- 挂载基础中间件：trust proxy / CORS / compression / JSON / 注入 `req.io`：[server.js](file:///f:/C/backend/server.js#L49-L56)
- REST 路由集中挂载（见路由地图）：[server.js](file:///f:/C/backend/server.js#L66-L88)
- Socket 鉴权中间件与连接处理：
  - `io.use(socketAuth)`：[server.js](file:///f:/C/backend/server.js#L89-L94)
  - `initSocketHandlers(io, socket)`：[handlers.js](file:///f:/C/backend/socket/handlers.js)
- 托管前端静态资源与 SPA fallback：
  - dist 静态资源缓存策略：[server.js](file:///f:/C/backend/server.js#L96-L107)
  - uploads 静态目录策略（posts 目录下非媒体强制下载）：[server.js](file:///f:/C/backend/server.js#L109-L125)
  - SPA fallback（非 `/api` 时回 `index.html`）：[server.js](file:///f:/C/backend/server.js#L127-L133)
- 启动阶段初始化外部依赖并开始监听端口：
  - MySQL 初始化 + 字段/索引补齐：[connection.js](file:///f:/C/backend/database/connection.js#L6-L33)
  - 默认游戏类型初始化：[server.js](file:///f:/C/backend/server.js#L148-L148)
  - 房间清理服务启动：[server.js](file:///f:/C/backend/server.js#L149-L149)
  - Redis 初始化：[server.js](file:///f:/C/backend/server.js#L151-L153)
  - Socket.IO Redis Adapter（多实例事件同步）：[server.js](file:///f:/C/backend/server.js#L154-L158)
  - 异步消息消费者（把后台消息推到 socket）：[server.js](file:///f:/C/backend/server.js#L159-L160)
  - `httpServer.listen(port, host)`：[server.js](file:///f:/C/backend/server.js#L162-L167)

## 管理入口：backend/admin-server.js
- 作用：独立端口启动“管理 API”服务（只挂载 `/api/admin`），并托管前端 dist 与 `/uploads`。
- 源码入口：[admin-server.js](file:///f:/C/backend/admin-server.js)

