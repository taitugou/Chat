# 房间对局模块：规则联网检索与实现差异分析
文档版本：v0.1.0  
关联应用版本：ttg-chat v1.0.0  
最后更新：2026-02-08  
范围：texas_holdem、zhajinhua、doudizhu、shengji、paodekuai、blackjack、sichuan_mahjong、guangdong_mahjong、guobiao_mahjong、ren_mahjong、xiangqi、weiqi、wuziqi、international_chess、junqi、niuniu、erbaban、touzi_bao

---

## 1. 目的
- 用“主流通行规则/常见线上规则”作为参照系，定位当前实现的缺口与潜在 Bug 点。
- 这些差异将直接转化为阶段 3/4 的测试用例与缺陷清单。

## 2. 德州扑克（Texas Hold’em）
### 2.1 通行规则要点（联网参照）
- 平局与分池：当多名玩家的最佳 5 张牌完全等价时，应平分奖池；多出来的最小筹码通常按按钮位顺时针规则分配。（来源：https://en.wikipedia.org/wiki/Texas_hold_%27em ）
- 踢脚（kicker）与同花/顺子比较：同一牌型需要按 5 张牌逐张比较来决定胜负，必要时使用踢脚；若完全相同则平分。（来源：https://poker.stackexchange.com/questions/4399/what-tie-breakers-exist ）
- 边池（side pot）：全下/筹码不足时应产生边池，并按“有资格争夺的玩家集合”分别结算。（通行扑克规则常识；建议在后续进一步选择更权威规则文本作为项目基准）

### 2.2 当前实现差异（基于仓库代码）
- 未实现分池：实现选取单一 winnerId，未对等价最优手牌进行 pot split。
- 未实现边池与 all-in：下注与结算模型未表达多池结构；测试时需验证“筹码不足”触发的服务端异常是否会导致状态推进不一致。
- 同牌型比较不完整：仅按 rank 与 highCard 比较，未覆盖完整的 5 张逐张比较（含 kicker 细则）。

### 2.3 直接转化的测试风险点
- 两名玩家同花/顺子相同最高牌但次高不同：应按次高比较；实现可能误判。
- 公共牌形成最佳 5 张（board plays）：多玩家应平分；实现会选出单一赢家。
- 玩家在行动中筹码不足：应进入 all-in/边池路径；实现将直接报错“筹码不足”，需验证对局状态是否仍保持一致。

## 3. 炸金花（Zhajinhua）
### 3.1 通行规则要点（联网参照）
- 牌型排序存在“地区/平台差异”：常见排序为 单张 < 对子 < 顺子 < 金花(同花) < 同花顺(顺金) < 豹子（三条）。（来源：https://zhuanlan.zhihu.com/p/717171407 ）
- “杂色 235 吃豹子”是常见可选规则，但具体吃法差异很大：有的平台是 235 吃所有豹子，有的只吃 AAA，有的完全不启用。（来源：https://jingyan.baidu.com/article/6d704a135d3fbe69db51caab.html ）

### 3.2 当前实现差异（基于仓库代码）
- 235 规则：实现为“只要对手是豹子且自己是杂色 2-3-5（非顺/同花/对子）即可获胜”，且可通过 enable235 开关关闭。
- 看牌下注翻倍：实现为看牌后下注单位 = baseBet*2（闷牌为 baseBet），这是常见线上规则之一，但不同平台也存在“闷牌更便宜/更贵”的变体。
- 未实现平局：当两手完全相同的情况，当前实现不会进入“平局/分池”，会硬选 winner。

### 3.3 直接转化的测试风险点
- 235 vs 豹子：需覆盖 enable235 开/关；以及“235 但同花/顺子/对子”不应触发吃豹子。
- A23 顺子：实现支持两种比较口径（low/second），需明确产品口径后固化为基准用例。
- 比牌成本：看牌与否影响单位注额；需覆盖“看牌后比牌成本翻倍”的场景。

## 4. 五子棋（Gomoku / Gobang）
### 4.1 通行规则要点（联网参照）
- 五子棋存在多个体系：自由规则（五连或更多即胜）、标准五子棋（通常要求“恰好五连”，长连不算）、以及 Renju（对黑棋有禁手如三三、四四、长连）。（来源：https://en.wikipedia.org/wiki/Gomoku ； https://gambiter.com/renju/Gomoku.html ）

### 4.2 当前实现差异（基于仓库代码）
- 当前实现属于自由规则：>=5 连即胜；未实现“恰好五连/长连无效”。
- 未实现 Renju 禁手：无三三/四四/长连禁手与开局规则。

### 4.3 直接转化的测试风险点
- 6 连：在标准规则中可能不算胜；当前实现会判胜。需明确产品口径，避免“规则争议型缺陷”。
- 坐标合法性：0–14 边界、重复落子、非当前回合落子等应严格报错且不改变棋盘。

## 5. 21点（Blackjack）
### 5.1 通行规则要点（联网参照）
- 基本目标：玩家点数尽量接近 21 且不爆牌；常见动作为 Hit/Stand/Double/Split。（来源：https://en.wikipedia.org/wiki/Blackjack ）
- 庄家规则常见约定：小于 17 必须要牌，17 及以上停牌；不同赌场对 soft 17 有差异。（来源：https://en.wikipedia.org/wiki/Blackjack ）

### 5.2 当前实现差异（基于仓库代码）
- 当前实现不含 split、投保等规则；double 仅支持“前两张牌时加倍+补 1 张牌后强制结束回合”。（以当前仓库实现为准）
- 赔付按实现口径：胜 bet*2、push bet、Blackjack 近似 bet*2.5（取整）。通行规则对 blackjack、赔率、结算细节在不同平台可能存在差异。

### 5.3 直接转化的测试风险点
- soft 17、A 计 1/11 的点数计算边界。
- double 前置条件（仅前两张）与筹码扣减一致性。

## 6. 牛牛（Niuniu / Dou Niu）
### 6.1 通行规则要点（联网参照）
- 五张牌分成“3+2”：三张点数和为 10 的倍数为“有牛”，两张点数和 %10 为“牛几”，为 0 则“牛牛”。（来源：https://zhuanlan.zhihu.com/p/717691912 ； https://baike.baidu.com/item/%E7%89%9B%E7%89%9B/3650447 ）
- 不同平台常有附加牌型与庄家/抢庄变体（五花牛、炸弹、五小牛等），以及花色比较细则差异。

### 6.2 当前实现差异（基于仓库代码）
- 当前实现采用“牛几/牛牛/无牛”的基础计算与简单比牌，未覆盖常见扩展牌型与复杂倍率体系。（以当前仓库实现为准）
- 结算为与庄家逐一对比的通用模式；庄家固定为座位 1（playerIds[0]）。

### 6.3 直接转化的测试风险点
- 无牛/有牛/牛牛的判定正确性（暴力枚举 5 张组合校验）。
- 相同牛值下的 tie-break（最大单牌/花色等）是否与产品口径一致。

## 7. 斗地主（Doudizhu）
### 7.1 通行规则要点（联网参照）
- 3 人一副 54 张，留 3 张底牌；叫分/叫地主，地主拿底牌并先出。（来源：https://m.91y.com/help/guize/63.html ）
- 王炸/炸弹可压制其它牌型；除炸弹外通常要求牌型相同且张数一致才能比较大小。（来源：https://m.91y.com/help/guize/63.html ）

### 7.2 当前实现差异（基于仓库代码）
- 当前实现为可测版：支持基础叫分与一组常见牌型（单/对/三/顺/连对/飞机及少量带牌与四带二）。倍率、春天、明牌等扩展规则未覆盖。（以当前仓库实现为准）
- 结算为 winner 独得 pot，不含倍数、队伍收益拆分等扩展玩法。

### 7.3 直接转化的测试风险点
- 牌型识别与比较（rocket/bomb 与普通牌型互压规则）。
- pass 规则：不能对自己过牌、全员过牌清空 lastPlay 的边界。

## 8. 跑得快（Paodekuai / 关牌）
### 8.1 通行规则要点（联网参照）
- 常见为去掉大小王与部分 2/A 的 48 张牌版本；出牌含单张/对子/顺子/连对/三带等，规则存在明显地区差异。（来源：https://baike.baidu.com/item/%E8%B7%91%E7%9A%84%E5%BF%AB/3581596 ； https://www.jj.cn/news/320/20111115101400019865.shtml ）

### 8.2 当前实现差异（基于仓库代码）
- 当前实现为可测版：牌型覆盖相对有限，且不含“必须管/放走包赔/炸弹奖分”等平台变体。（以当前仓库实现为准）
- 结算为 winner 独得 pot（通用筹码模型），不按剩余张数计分。

### 8.3 直接转化的测试风险点
- “牌型不足以压制上家”与“可出任意牌型”两个分支的正确性。
- 最后手允许的带牌数量等特殊口径是否与产品定义一致。

## 9. 升级（Shengji / Tractor）
### 9.1 通行规则要点（联网参照）
- 多副牌、两队对抗、分牌（5/10/K）与墩分是核心；拖拉机（连对）为重要牌型。（来源：https://www.pagat.com/kt5/tractor.html ）
- 规则族非常庞大，存在“找朋友/抠底/亮主/反主”等不同流派与细节差异。（来源：https://robertying.com/shengji/rules.html ）

### 9.2 当前实现差异（基于仓库代码）
- 当前实现为可玩规则版：以“主牌花色/主级牌”的最小模型实现跟牌与赢墩、简单计分与结算；不覆盖大量民间/赛事规则细节（抠底、升级进阶倍率、复杂甩牌判定等）。（以当前仓库实现为准）

### 9.3 直接转化的测试风险点
- 跟牌合法性（有主必跟主/有同花色必跟花色）的边界与异常提示。
- 计分牌统计与结算拆分（胜方两人分 pot）一致性。

## 10. 麻将（四川/广东/国标/二人）
### 10.1 通行规则要点（联网参照）
- 国标麻将属于统一竞赛规则体系（MCR），番种与起和要求与地方麻将差异很大。（来源：https://zh.wikipedia.org/zh-hans/%E5%9B%BD%E6%A0%87%E9%BA%BB%E5%B0%86 ）
- 地方麻将（如四川/广东）通常有更强的地方性规则（缺门、血战到底、买马、番种体系等），平台差异显著。

### 10.2 当前实现差异（基于仓库代码）
- 当前实现为“最小可测实现”：提供发牌、摸打、吃碰杠与最基础胡牌判定/强制结算路径；不覆盖国标/地方麻将的完整番种与计分体系。（以当前仓库实现为准）

### 10.3 直接转化的测试风险点
- 行为窗口：吃/碰/杠/点炮胡对 lastDiscard 的关联与时序冲突（并发点击/多家同时可碰等）。
- 牌墙耗尽、回合上限 maxTurns 的强制结算一致性。

## 11. 骰宝（Sic Bo / 骰寶 / touzi_bao）
### 11.1 通行规则要点（联网参照）
- 大/小：sum 4–10 为 small，11–17 为 big；多数规则下出现豹子（三骰同点）时大/小下注判负。（来源：https://en.wikipedia.org/wiki/Sic_bo ）

### 11.2 当前实现差异（基于仓库代码）
- 当前实现仅支持 big/small 下注与开骰；豹子时全员判负，未提供其它投注盘（点数、围骰等）。（以当前仓库实现为准）

### 11.3 直接转化的测试风险点
- 多人下注回合轮转、roll 权限（仅座位 1）与状态推进一致性。

## 12. 二八杠（Erbaban / 推筒子变体）
### 12.1 通行规则要点（联网参照）
- 常见比较口径：先比对子，再比点数；“二八（2+8）”常作为特殊大牌（各地也存在差异）。（来源：https://baike.baidu.com/item/%E4%BA%8C%E5%85%AB%E6%9D%A0/9997649 ）

### 12.2 当前实现差异（基于仓库代码）
- 当前实现为可测版：以两骰结果/点数组合做简化比较并结算，不覆盖庄家、门位、抽水、赔率等平台规则。（以当前仓库实现为准）

### 12.3 直接转化的测试风险点
- 组合大小（28、对子、普通点数）的比较顺序与 tie-break。

## 13. 中国象棋（Xiangqi）
### 13.1 通行规则要点（联网参照）
- 走子规则、将军与将死、不得“送将”、将帅不得照面等为核心约束。（来源：https://en.wikipedia.org/wiki/Xiangqi ）

### 13.2 当前实现差异（基于仓库代码）
- 当前实现支持完整走子校验与基本终局判定（以当前仓库实现为准）；不覆盖长将/长捉等更细的裁判规则口径。

### 13.3 直接转化的测试风险点
- 非法走子必须拒绝且不改变棋盘；将军态下的合法解将路径覆盖。

## 14. 围棋（Weiqi / Go）
### 14.1 通行规则要点（联网参照）
- 提子、自杀禁入、劫（ko）限制、连续两次 pass 结束后计分。（来源：https://en.wikipedia.org/wiki/Go_(game) ）

### 14.2 当前实现差异（基于仓库代码）
- 当前实现支持落子/提子/自杀禁入/ko 与 pass/settle（以当前仓库实现为准）；计分采用“子数+提子+贴目”的简化口径，未覆盖数目法/死活争议处理等。

### 14.3 直接转化的测试风险点
- ko 复现、连续 pass 触发结算、边界落子与提子连锁。

## 15. 国际象棋（International Chess）
### 15.1 通行规则要点（联网参照）
- 标准走子规则、易位、吃过路兵、升变、将死/逼和。（来源：https://en.wikipedia.org/wiki/Rules_of_chess ）

### 15.2 当前实现差异（基于仓库代码）
- 当前实现包含易位与吃过路兵，升变默认后（以当前仓库实现为准）；对和棋与重复局面等裁判规则支持程度需用例验证。

### 15.3 直接转化的测试风险点
- 易位合法性（路径被攻击/王车移动过等）与吃过路兵时序校验。

## 16. 军棋（Junqi）
### 16.1 通行规则要点（联网参照）
- 基本军阶大小、地雷/工兵、炸弹同归于尽、夺旗胜等为常见规则骨架；不同平台在棋盘线路/行营安全岛/布阵限制上差异较大。（来源：https://zh.wikipedia.org/zh-hans/%E9%99%B8%E8%BB%8D%E6%A3%8B ）

### 16.2 当前实现差异（基于仓库代码）
- 当前实现支持布阵（含 autoSetup）、移动与战斗结算，炸弹同归于尽、工兵挖雷、夺旗胜（以当前仓库实现为准）；未覆盖四国军棋等复杂变体。

### 16.3 直接转化的测试风险点
- 布阵合法性（重复放置、非法棋子、未完成布阵开局）与 autoSetup 的可重复性。

## 17. 建议的“项目规则基线”落地方式
- 以“当前实现”为基准用于回归稳定性测试，同时把“通行规则差异”登记为产品缺陷/需求缺口（需要确认是否纳入本版本修复范围）。
- 若要补齐德州的分池/边池/完整比较：建议先固化一份权威规则文本作为验收标准，再开始修复与补测。
