# 积分系统问题诊断和解决方案

## 问题描述
前端访问积分页面时出现错误：`获取积分数据失败`

## 问题分析

### 1. 端口冲突
从后端日志可以看到：
```
Error: listen EADDRINUSE: address already in use 0.0.0.0:888
```
这说明：
- 后端服务器尝试监听端口888，但该端口已被占用
- 前端开发服务器运行在端口8888上
- 端口888可能被其他进程占用

### 2. 可能的占用进程
- 前端开发服务器（Vite）运行在8888端口
- 之前启动的后端服务器实例
- 其他应用程序

## 解决方案

### 方案1：停止占用端口的进程（推荐）

#### Windows系统
```powershell
# 查找占用888端口的进程
netstat -ano | findstr :8888

# 如果找到进程，使用以下命令停止（替换PID为实际的进程ID）
taskkill /PID <进程ID> /F

# 或者强制停止所有Node进程
taskkill /F /IM node.exe
```

#### 查找并停止进程的步骤
1. 打开命令提示符（PowerShell或CMD）
2. 运行 `netstat -ano | findstr :8888` 查找占用进程
3. 记录进程ID（PID）
4. 运行 `taskkill /PID <进程ID> /F` 停止进程
5. 重新启动后端服务器

### 方案2：修改端口配置

#### 修改后端端口
编辑 `f:\C\backend\.env` 文件：
```env
PORT=8889  # 改为其他端口（如8889）
```

#### 修改前端代理配置
编辑 `f:\C\frontend\vite.config.js` 文件：
```javascript
proxy: {
  '/api': {
    target: 'http://localhost:8889',  // 改为与后端相同的端口
    changeOrigin: true,
  },
}
```

### 方案3：使用不同的启动命令

#### 仅启动后端（不启动前端）
```bash
cd f:\C\backend
npm run dev
```

#### 仅启动前端（不启动后端）
```bash
cd f:\C
npm run dev:frontend
```

## 已完成的修复

### 1. 积分系统功能
✅ 创建了积分管理工具函数（pointsManager.js）
✅ 修复了事务处理问题
✅ 创建了任务系统（task.js）
✅ 创建了邀请系统
✅ 在用户注册时自动创建默认任务

### 2. 积分获取途径

#### 获取方式
| 方式 | 积分 | 说明 |
|------|------|------|
| 每日签到 | +10 | 基础奖励 |
| 连续签到3天 | +10 | 额外奖励 |
| 连续签到7天 | +20 | 额外奖励 |
| 发布帖子 | +5 | 每次发布 |
| 帖子获得点赞 | +2 | 帖子作者获得 |
| 帖子获得评论 | +3 | 帖子作者获得 |
| 帖子被转发 | +4 | 原帖子作者获得 |
| 被关注 | +1 | 被关注用户获得 |
| 发布3篇帖子 | +15 | 任务奖励 |
| 点赞5次 | +5 | 任务奖励 |
| 评论3次 | +5 | 任务奖励 |
| 邀请好友 | +50 | 任务奖励 |
| 完善资料 | +20 | 任务奖励 |
| 累计100赞 | +30 | 成就奖励 |
| 累计50帖 | +50 | 成就奖励 |

#### 消耗方式
| 方式 | 积分 | 说明 |
|------|------|------|
| 匹配插队 | 2×2^n | 第1次2积分，第2次4积分，第3次8积分... |
| 帖子推广 | 100/天 | 提升帖子曝光度 |

### 3. 新增API接口

#### 积分相关
- `GET /api/user/points` - 获取积分余额
- `GET /api/user/points/records` - 获取积分记录
- `GET /api/user/points/ranking` - 获取积分排行

#### 签到相关
- `POST /api/settings/checkin` - 每日签到
- `GET /api/settings/checkin/status` - 获取签到状态

#### 任务相关
- `GET /api/task/tasks` - 获取任务列表
- `POST /api/task/tasks/:taskId/complete` - 完成任务
- `POST /api/task/invite/:code` - 使用邀请码
- `POST /api/task/invite/generate` - 生成邀请码
- `GET /api/task/invite/code` - 获取我的邀请码
- `GET /api/task/invite/records` - 获取邀请记录
- `POST /api/task/profile/complete` - 完善资料奖励

### 4. 数据库表结构

#### 新增表
- `user_tasks` - 任务表
- `user_invitations` - 邀请表
- `user_rewards` - 奖励记录表

#### 已有表
- `point_records` - 积分记录表
- `users.points` - 用户积分字段

## 快速修复步骤

### 步骤1：停止占用端口的进程
```powershell
# 在PowerShell中运行
netstat -ano | findstr :8888
taskkill /F /IM node.exe
```

### 步骤2：重新启动后端
```bash
cd f:\C\backend
npm run dev
```

### 步骤3：刷新前端页面
1. 打开浏览器
2. 访问 http://localhost:8888
3. 刷新积分页面
4. 测试签到、获取积分等功能

## 验证清单

- [ ] 后端服务器成功启动（端口888）
- [ ] 前端可以访问后端API
- [ ] 签到功能正常工作
- [ ] 积分余额正确显示
- [ ] 积分记录正确显示
- [ ] 积分排行正确显示
- [ ] 任务列表正确显示

## 技术说明

### 为什么会出现端口冲突？
1. Vite开发服务器默认使用8888端口
2. 后端服务器也配置为888端口
3. 两个服务不能同时监听同一个端口

### 推荐的开发环境配置

#### 后端配置（.env）
```env
PORT=8889
HOST=0.0.0.0
```

#### 前端配置（vite.config.js）
```javascript
server: {
  port: 8888,
  host: '0.0.0.0',
},
```

这样配置可以避免端口冲突。

## 注意事项

1. 每次修改配置后需要重启服务器
2. 确保没有其他程序占用目标端口
3. 如果问题持续，检查防火墙设置
4. 开发时建议使用不同的端口避免冲突

## 联系支持

如果以上方案都无法解决问题，请提供以下信息：
1. 完整的错误日志
2. 运行 `netstat -ano` 的结果
3. 运行 `tasklist` 的结果
4. 操作系统版本
