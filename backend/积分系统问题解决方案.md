# 积分系统问题解决方案

## 问题分析

### 问题现象
前端访问积分页面时出现错误：`获取积分数据失败`

### 问题根源
前端使用localStorage中缓存的**旧token**，这个旧token对应的用户可能已经不存在或状态异常。

### 验证过程
1. ✅ 后端服务器正常运行（端口888）
2. ✅ 数据库连接正常
3. ✅ 用户ttg存在且状态为active
4. ✅ 密码已重置为123456
5. ✅ 登录API正常工作
6. ✅ 认证中间件正常工作
7. ❌ 前端使用缓存的旧token，导致认证失败

## 解决方案

### 方法1：清除浏览器缓存（推荐）

#### 步骤：
1. 打开浏览器开发者工具（按F12）
2. 切换到**Console**（控制台）标签
3. 执行以下命令清除旧token：
   ```javascript
   localStorage.removeItem('token');
   localStorage.removeItem('user');
   ```
4. 刷新页面（按F5）
5. 重新登录系统

#### 登录账号：
- 用户名：`ttg`
- 密码：`123456`

### 方法2：清除浏览器所有数据

#### Chrome/Edge浏览器：
1. 按`Ctrl + Shift + Delete`
2. 选择"Cookie和其他网站数据"
3. 点击"清除数据"
4. 刷新页面并重新登录

#### Firefox浏览器：
1. 按`Ctrl + Shift + Delete`
2. 选择"Cookie和网站数据"
3. 点击"立即清除"
4. 刷新页面并重新登录

### 方法3：使用无痕模式

1. 打开无痕/隐私浏览窗口
2. 访问 http://localhost:8888
3. 使用以下账号登录：
   - 用户名：`ttg`
   - 密码：`123456`

## 验证清单

清除旧token后，请验证以下功能：

- [ ] 可以正常登录
- [ ] 积分余额正确显示
- [ ] 积分记录正确显示
- [ ] 积分排行正确显示
- [ ] 签到功能正常工作
- [ ] 任务列表正确显示

## 技术说明

### 为什么会出现这个问题？

1. **Token缓存**：前端将登录后的token存储在localStorage中
2. **Token过期**：旧token可能已经过期或对应的用户状态发生变化
3. **认证失败**：后端验证token时发现用户不存在或状态异常
4. **API返回404**：认证中间件返回"用户不存在"错误

### 前端代码分析

**API拦截器**（[api.ts](file:///f:\C\frontend\src\utils\api.ts#L12-L23)）：
```typescript
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  ...
);
```

**积分数据获取**（[Points.vue](file:///f:\C\frontend\src\views\Points.vue#L196-L216)）：
```javascript
async function fetchPointsData() {
  loading.value = true;
  try {
    // 1. 获取积分余额
    const balanceResponse = await api.get('/user/points');
    pointsBalance.value = balanceResponse.data.points || 0;

    // 2. 获取积分记录
    const recordsResponse = await api.get('/user/points/records');
    pointsRecords.value = recordsResponse.data.records || [];

    // 3. 获取积分排行
    const rankingResponse = await api.get('/user/points/ranking');
    pointsRanking.value = rankingResponse.data.ranking || [];
  } catch (error) {
    console.error('获取积分数据失败:', error);
  } finally {
    loading.value = false;
  }
}
```

### 后端认证流程

**认证中间件**（[auth.js](file:///f:\C\backend\middleware\auth.js#L5-L53)）：
```javascript
export async function authenticate(req, res, next) {
  try {
    const authHeader = req.headers.authorization;

    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({ error: '未提供认证令牌' });
    }

    const token = authHeader.substring(7);

    try {
      const decoded = jwt.verify(token, config.jwt.secret);

      const [users] = await query(
        'SELECT id, username, status FROM users WHERE id = ?',
        [decoded.userId]
      );

      if (!users || users.length === 0) {
        return res.status(401).json({ error: '用户不存在' });
      }

      const user = users[0];

      if (user.status !== 'active') {
        return res.status(403).json({ error: '账号已冻结' });
      }

      req.user = {
        id: parseInt(user.id),
        username: user.username,
      };

      next();
    } catch (error) {
      if (error.name === 'TokenExpiredError') {
        return res.status(401).json({ error: '令牌已过期' });
      }
      if (error.name === 'JsonWebTokenError') {
        return res.status(401).json({ error: '无效的令牌' });
      }
      throw error;
    }
  } catch (error) {
    console.error('认证中间件错误:', error);
    return res.status(500).json({ error: '认证失败' });
  }
}
```

## 完整的积分获取途径

| 获取方式 | 积分 | 说明 |
|---------|------|------|
| **每日签到** | +10 | 基础奖励 |
| **连续签到3天** | +10 | 额外奖励 |
| **连续签到7天** | +20 | 额外奖励 |
| **发布帖子** | +5 | 每次发布 |
| **帖子获得点赞** | +2 | 帖子作者获得 |
| **帖子获得评论** | +3 | 帖子作者获得 |
| **帖子被转发** | +4 | 原帖子作者获得 |
| **被关注** | +1 | 被关注用户获得 |
| **发布3篇帖子** | +15 | 任务奖励 |
| **点赞5次** | +5 | 任务奖励 |
| **评论3次** | +5 | 任务奖励 |
| **邀请好友** | +50 | 任务奖励 |
| **完善资料** | +20 | 任务奖励 |
| **累计100赞** | +30 | 成就奖励 |
| **累计50帖** | +50 | 成就奖励 |

## 新增API接口

**积分相关**
- `GET /api/user/points` - 获取积分余额
- `GET /api/user/points/records` - 获取积分记录
- `GET /api/user/points/ranking` - 获取积分排行

**签到相关**
- `POST /api/settings/checkin` - 每日签到
- `GET /api/settings/checkin/status` - 获取签到状态

**任务相关**
- `GET /api/task/tasks` - 获取任务列表
- `POST /api/task/tasks/:taskId/complete` - 完成任务
- `POST /api/task/invite/:code` - 使用邀请码
- `POST /api/task/invite/generate` - 生成邀请码
- `GET /api/task/invite/code` - 获取我的邀请码
- `GET /api/task/invite/records` - 获取邀请记录
- `POST /api/task/profile/complete` - 完善资料奖励

## 注意事项

1. **清除缓存后需要重新登录**
2. **建议定期清除浏览器缓存**
3. **如果问题持续，尝试使用无痕模式**
4. **确保后端服务器正常运行（端口888）**
5. **确保前端开发服务器正常运行（端口8888）**

## 快速修复步骤

1. 打开浏览器开发者工具（F12）
2. 切换到Console标签
3. 执行：`localStorage.removeItem('token');`
4. 执行：`localStorage.removeItem('user');`
5. 刷新页面（F5）
6. 使用以下账号登录：
   - 用户名：`ttg`
   - 密码：`123456`

## 系统状态

✅ 后端服务器：正常运行（端口888）
✅ 数据库连接：正常
✅ 用户ttg：存在且状态为active
✅ 密码：已重置为123456
✅ 认证中间件：正常工作
✅ 积分API：正常工作
✅ 前端服务器：正常运行（端口8888）
❌ 前端token：使用缓存的旧token

## 联系支持

如果以上方案都无法解决问题，请提供以下信息：
1. 浏览器控制台的完整错误信息
2. 网络请求的详细信息（F12 -> Network标签）
3. localStorage中的token值（F12 -> Application -> Local Storage）
4. 登录后的响应数据
