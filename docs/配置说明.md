# TTG Chat 配置说明

本文档说明需要用户自行配置的内容。

## 1. 必须配置项

### 1.1 数据库配置

**位置**: `backend/.env`

```env
DB_HOST=localhost          # MySQL主机地址
DB_PORT=3306              # MySQL端口
DB_USER=root              # MySQL用户名
DB_PASSWORD=123456        # MySQL密码（默认123456，生产环境请修改）
DB_NAME=ttg_chat          # 数据库名
```

**注意**: 生产环境必须修改默认密码！

### 1.2 JWT密钥

**位置**: `backend/.env`

```env
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
```

**重要**: 生产环境必须使用强随机密钥！

生成方式：
```bash
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

### 1.3 API地址配置

**位置**: `frontend/.env`

```env
VITE_API_BASE_URL=/api
```

生产环境（前后端同域同端口）也推荐保持相对路径：
```env
VITE_API_BASE_URL=/api
```

如需显式指定完整地址：
```env
VITE_API_BASE_URL=https://taitugou.top:888/api
```

## 2. 可选配置项

### 2.1 Redis配置

**位置**: `backend/.env`

```env
REDIS_HOST=localhost      # Redis主机
REDIS_PORT=6379          # Redis端口
REDIS_PASSWORD=          # Redis密码（如无密码留空）
```

### 2.2 文件上传配置

**位置**: `backend/.env`

```env
UPLOAD_DIR=./uploads                    # 上传目录
MAX_FILE_SIZE=10485760                  # 最大文件大小（10MB）
ALLOWED_IMAGE_TYPES=jpg,jpeg,png,gif    # 允许的图片类型
ALLOWED_VIDEO_TYPES=mp4,webm            # 允许的视频类型
```

### 2.3 内网穿透配置

**位置**: `backend/.env`

```env
FRP_ENABLED=false        # 是否启用内网穿透
FRP_DOMAIN=              # frp域名（如：app.yourdomain.com）
```

### 2.4 CORS配置

**位置**: `backend/.env`

```env
CORS_ORIGIN=https://taitugou.top:888
```

生产环境应配置为实际前端域名：
```env
CORS_ORIGIN=https://taitugou.top:888
```

### 2.5 WebRTC ICE（语音 / 游戏语音 Mesh / P2P）

**位置**: `frontend/.env`

```env
VITE_ICE_SERVERS=
```

用途：
- 语音/视频通话、以及房间对局里的“语音 Mesh”使用 WebRTC，需要 ICE Servers（STUN/TURN）在 NAT/复杂网络下完成打洞与回退。
- 项目会优先尝试“直连”（尤其是 IPv6 具备公网可达时的 host/mesh 直连），若短时间内未连通，再回退到 `VITE_ICE_SERVERS` 提供的 STUN/TURN。

配置格式（二选一）：
1) JSON（推荐，可写用户名/密码等）
```env
VITE_ICE_SERVERS=[{"urls":["stun:stun.example.com:3478"]}]
```

2) 逗号分隔 URL（仅 urls）
```env
VITE_ICE_SERVERS=stun:stun.example.com:3478,turns:turn.example.com:5349
```

IPv6 直连建议：
- STUN/TURN 域名尽量同时具备 AAAA 记录（IPv6），并确保服务器与防火墙允许 UDP/TCP（TURN 视部署而定）。
- 若你的目标环境主要是公网 IPv6 mesh 直连，可保持 STUN 轻量即可；TURN 主要用于“必须穿透”的保底回退。

## 3. 第三方API配置

### 3.1 短信服务（可选）

如需短信验证功能，需要配置短信服务商API：

**位置**: `backend/.env`

```env
SMS_PROVIDER=aliyun      # 服务商：aliyun, tencent, etc.
SMS_ACCESS_KEY=         # Access Key
SMS_SECRET_KEY=         # Secret Key
SMS_SIGN_NAME=          # 签名
SMS_TEMPLATE_CODE=      # 模板代码
```

### 3.2 邮件服务（可选）

如需邮件验证功能，需要配置SMTP服务：

**位置**: `backend/.env`

```env
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASSWORD=your-password
SMTP_FROM=TTG Chat <noreply@example.com>
```

### 3.3 支付服务（可选）

如需在线支付功能，需要配置支付服务商：

**位置**: `backend/.env`

```env
# 微信支付
WECHAT_APP_ID=
WECHAT_MCH_ID=
WECHAT_API_KEY=

# 支付宝
ALIPAY_APP_ID=
ALIPAY_PRIVATE_KEY=
ALIPAY_PUBLIC_KEY=
```

## 4. 管理员账号配置

### 4.1 默认管理员

数据库初始化脚本会创建一个默认管理员账号：
- 用户名: `admin`
- 密码: `admin123` (需要修改)

### 4.2 修改管理员密码

1. 登录系统
2. 进入个人设置
3. 修改密码

或直接在数据库中修改：

```sql
-- 生成新密码哈希（密码：newpassword）
-- 使用bcrypt在线工具生成哈希值
UPDATE users SET password_hash = '$2a$10$...' WHERE username = 'admin';
```

## 5. 安全配置

### 5.1 生产环境检查清单

- [ ] 修改MySQL root密码
- [ ] 修改JWT密钥
- [ ] 配置HTTPS
- [ ] 设置CORS白名单
- [ ] 配置防火墙规则
- [ ] 启用日志记录
- [ ] 配置备份策略
- [ ] 设置文件上传限制
- [ ] 配置速率限制
- [ ] 启用安全头

### 5.2 环境变量安全

- 不要将 `.env` 文件提交到版本控制
- 使用环境变量管理敏感信息
- 定期轮换密钥和密码

## 6. 性能配置

### 6.1 数据库连接池

**位置**: `backend/config.js`

```javascript
connectionLimit: 10,  // 根据服务器性能调整
```

### 6.2 Redis缓存过期时间

**位置**: `backend/database/redis.js`

根据业务需求调整缓存过期时间

### 6.3 Nginx缓存

**位置**: `nginx/nginx.conf`

```nginx
expires 1y;  # 静态资源缓存时间
```

## 7. 功能开关

### 7.1 功能模块开关

可以在 `backend/config.js` 中添加功能开关：

```javascript
features: {
  smsVerification: false,
  emailVerification: false,
  payment: false,
  // ...
}
```

## 8. 自定义配置

### 8.1 主题颜色

**位置**: `frontend/tailwind.config.js`

```javascript
colors: {
  primary: '#6366F1',  // 主色调
  secondary: '#8B5CF6', // 辅助色
  // ...
}
```

### 8.2 应用信息

**位置**: `frontend/index.html`

```html
<title>TTG Chat</title>
<meta name="description" content="TTG Chat - 社交聊天应用" />
```

## 9. 配置验证

### 9.1 检查配置

启动服务前，检查以下配置：

```bash
# 检查环境变量
cd backend
node -e "require('dotenv').config(); console.log(process.env.DB_HOST)"

# 检查数据库连接
mysql -u root -p123456 -e "USE ttg_chat; SHOW TABLES;"

# 检查Redis连接
redis-cli ping
```

### 9.2 配置测试

运行配置测试脚本（如需要）：

```bash
npm run test:config
```

## 10. 配置更新

### 10.1 更新配置后

1. 重启后端服务
2. 重新构建前端（如配置了环境变量）
3. 清除浏览器缓存（如修改了前端配置）

### 10.2 配置备份

建议将配置文件备份：

```bash
cp backend/.env backend/.env.backup
cp frontend/.env frontend/.env.backup
```

