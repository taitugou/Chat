# TTG Chat 部署指南

## 1. 环境要求

### 1.1 系统要求

- **操作系统**: Windows 10/11 或 Windows Server
- **Node.js**: >= 18.0.0
- **MySQL**: >= 8.0
- **Redis**: >= 7.0
- **Nginx**: >= 1.24 (可选，用于生产环境)

### 1.2 开发工具

- Git
- VS Code (推荐)
- MySQL Workbench (可选)

## 2. 安装步骤

### 2.1 克隆项目

```bash
git clone <repository-url>
cd ttg-chat
```

### 2.2 安装依赖

```bash
# 安装所有依赖
npm run install:all

# 或分别安装
npm install
cd frontend && npm install
cd ../backend && npm install
```

### 2.3 配置环境变量

#### 后端配置

复制 `backend/.env.example` 为 `backend/.env`：

```bash
cd backend
copy .env.example .env
```

编辑 `backend/.env`，配置以下内容：

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=ttg_chat

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT密钥（生产环境请修改）
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# 内网穿透配置（如需要）
FRP_ENABLED=false
FRP_DOMAIN=
```

#### 前端配置

复制 `frontend/.env.example` 为 `frontend/.env`：

```bash
cd frontend
copy .env.example .env
```

编辑 `frontend/.env`：

```env
VITE_API_BASE_URL=http://localhost:3000
VITE_SOCKET_IO_PATH=/socket.io
```

### 2.4 初始化数据库

1. 确保MySQL服务已启动
2. 使用root用户登录MySQL（密码：123456）

```bash
mysql -u root -p123456
```

3. 执行初始化脚本

```bash
mysql -u root -p123456 < database/init.sql
```

或在MySQL客户端中执行：

```sql
source database/init.sql
```

### 2.5 启动Redis

确保Redis服务已启动：

```bash
# Windows下启动Redis（如果使用Redis服务）
redis-server
```

### 2.6 创建上传目录

```bash
mkdir backend\uploads
mkdir backend\uploads\avatars
mkdir backend\uploads\posts
```

## 3. 启动服务

### 3.1 开发模式

#### 启动后端

```bash
cd backend
npm run dev
```

后端服务将在 `http://localhost:3000` 启动

#### 启动前端

```bash
cd frontend
npm run dev
```

前端服务将在 `http://localhost:5173` 启动

### 3.2 生产模式

#### 构建前端

```bash
cd frontend
npm run build
```

构建产物在 `frontend/dist` 目录

#### 启动后端

```bash
cd backend
npm start
```

#### 配置Nginx

1. 复制 `nginx/nginx.conf` 到Nginx配置目录
2. 修改配置中的路径
3. 重启Nginx

## 4. 内网穿透配置（frp）

### 4.1 安装frp

从 [frp releases](https://github.com/fatedier/frp/releases) 下载Windows版本

### 4.2 配置frp客户端

创建 `frpc.ini`：

```ini
[common]
server_addr = your-server-ip
server_port = 7000
token = your_secret_token

[web]
type = http
local_port = 3000
subdomain = app
```

### 4.3 启动frp客户端

```bash
frpc.exe -c frpc.ini
```

### 4.4 配置后端

在 `backend/.env` 中设置：

```env
FRP_ENABLED=true
FRP_DOMAIN=app.your-domain.com
```

## 5. 常见问题

### 5.1 数据库连接失败

- 检查MySQL服务是否启动
- 检查用户名密码是否正确
- 检查数据库是否存在

### 5.2 Redis连接失败

- 检查Redis服务是否启动
- 检查端口是否正确
- 检查密码是否正确

### 5.3 端口被占用

- 修改 `backend/.env` 中的 `PORT`
- 修改 `frontend/vite.config.js` 中的 `server.port`

### 5.4 文件上传失败

- 检查 `backend/uploads` 目录是否存在
- 检查目录权限
- 检查文件大小限制

## 6. 生产环境优化

### 6.1 使用PM2管理进程

```bash
npm install -g pm2
cd backend
pm2 start server.js --name ttg-backend
```

### 6.2 配置HTTPS

在Nginx配置中添加SSL证书：

```nginx
server {
    listen 443 ssl;
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    # ...
}
```

### 6.3 数据库优化

- 配置MySQL连接池大小
- 启用查询缓存
- 定期优化表

### 6.4 缓存优化

- 配置Redis持久化
- 设置合理的过期时间
- 使用Redis集群（高并发场景）

## 7. 监控和日志

### 7.1 日志位置

- 后端日志: `backend/logs/`
- Nginx日志: `/var/log/nginx/` (Linux) 或 `C:\nginx\logs\` (Windows)

### 7.2 监控指标

- 服务器CPU、内存使用率
- 数据库连接数
- Redis内存使用
- API响应时间

## 8. 备份策略

### 8.1 数据库备份

```bash
mysqldump -u root -p123456 ttg_chat > backup_$(date +%Y%m%d).sql
```

### 8.2 文件备份

```bash
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz backend/uploads/
```

### 8.3 自动备份脚本

创建定时任务，每天自动备份数据库和文件

