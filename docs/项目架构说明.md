# TTG Chat 项目架构说明

## 1. 整体架构

TTG Chat 采用前后端分离的架构设计，主要包含以下部分：

### 1.1 技术栈

- **前端**: Vue.js 3 + TypeScript + Vite + Pinia + Tailwind CSS
- **后端**: Node.js + Express + Socket.IO
- **数据库**: MySQL 8.0
- **缓存**: Redis 7.x
- **Web服务器**: Nginx

### 1.2 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端浏览器                          │
│                    (Vue.js 3 + TypeScript)                   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ HTTP/WebSocket
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                         Nginx                                │
│                    (反向代理 + 静态资源)                      │
└─────┬──────────────────┬──────────────────┬────────────────┘
      │                  │                  │
      │                  │                  │
┌─────▼─────┐    ┌──────▼──────┐    ┌──────▼──────┐
│  前端静态  │    │  后端API    │    │  Socket.IO  │
│   资源    │    │  服务       │    │  实时通信   │
└───────────┘    └──────┬──────┘    └──────┬──────┘
                        │                  │
                        └────────┬─────────┘
                                 │
                    ┌────────────▼────────────┐
                    │      Express Server      │
                    │   (Node.js + Express)    │
                    └─────┬──────────┬─────────┘
                          │          │
                ┌─────────▼──┐  ┌───▼────────┐
                │   MySQL    │  │   Redis    │
                │  (数据存储) │  │  (缓存)    │
                └────────────┘  └────────────┘
```

## 2. 前端架构

### 2.1 目录结构

```
frontend/
├── src/
│   ├── views/          # 页面组件
│   ├── components/     # 公共组件
│   ├── stores/         # Pinia状态管理
│   ├── router/         # 路由配置
│   ├── utils/          # 工具函数
│   ├── App.vue         # 根组件
│   └── main.ts         # 入口文件
├── public/             # 静态资源
├── index.html          # HTML模板
├── vite.config.js      # Vite配置
└── package.json        # 依赖配置
```

### 2.2 核心模块

- **路由管理**: Vue Router 4，支持路由守卫和懒加载
- **状态管理**: Pinia，管理用户认证、应用状态
- **HTTP请求**: Axios，统一封装API请求
- **实时通信**: Socket.IO Client，处理实时消息和通知
- **UI框架**: Tailwind CSS，响应式设计

## 3. 后端架构

### 3.1 目录结构

```
backend/
├── routes/            # 路由模块
│   ├── auth.js        # 认证路由
│   ├── user.js        # 用户路由
│   ├── post.js        # 帖子路由
│   ├── chat.js        # 聊天路由
│   ├── match.js       # 匹配路由
│   ├── vip.js         # VIP路由
│   └── admin.js       # 管理路由
├── middleware/         # 中间件
│   ├── auth.js        # 认证中间件
│   ├── socketAuth.js  # Socket认证
│   └── errorHandler.js # 错误处理
├── database/          # 数据库
│   ├── connection.js  # MySQL连接
│   └── redis.js       # Redis连接
├── socket/            # Socket.IO处理
│   └── handlers.js    # Socket事件处理
├── config.js          # 配置文件
└── server.js          # 服务器入口
```

### 3.2 核心模块

- **认证系统**: JWT无状态认证，支持刷新令牌
- **数据库**: MySQL连接池，支持事务
- **缓存**: Redis，用于会话、在线用户、匹配队列
- **实时通信**: Socket.IO，处理实时消息和匹配
- **文件上传**: Multer，支持图片、视频上传

## 4. 数据库设计

### 4.1 核心表结构

- **users**: 用户表
- **posts**: 帖子表
- **messages**: 消息表
- **user_friends**: 好友关系表
- **user_blacklist**: 黑名单表
- **match_history**: 匹配历史表
- **vip_codes**: VIP兑换码表
- **renewal_cards**: 续期卡表

详细表结构请参考 `database/init.sql`

## 5. 安全机制

- **JWT认证**: 无状态认证，支持过期和刷新
- **密码加密**: bcrypt加密存储
- **请求限流**: express-rate-limit防止暴力破解
- **输入验证**: 所有输入进行验证和过滤
- **CORS配置**: 限制跨域请求
- **安全头**: Helmet中间件设置安全头

## 6. 性能优化

- **静态资源缓存**: Nginx配置1年缓存
- **数据库连接池**: 复用数据库连接
- **Redis缓存**: 缓存热点数据
- **代码分割**: Vite自动代码分割
- **图片压缩**: Sharp自动压缩上传图片

## 7. 部署架构

### 7.1 开发环境

- 前端: Vite 开发服务器 (https://localhost:8888)
- 后端: Node.js 开发服务器 (https://localhost:888)
- 数据库: MySQL本地实例
- 缓存: Redis本地实例

### 7.2 生产环境

- 前端: 由后端同进程托管 `frontend/dist`
- 后端: Node.js PM2进程管理 (https://taitugou.top:888)
- 数据库: MySQL主从复制（可选）
- 缓存: Redis集群（可选）
- 反向代理: Nginx负载均衡

## 8. 内网穿透支持

项目支持通过frp进行内网穿透，配置在 `backend/.env` 中：

```env
FRP_ENABLED=true
FRP_DOMAIN=your-domain.com
```

详细配置请参考 `docs/部署指南.md`

